name: YML & Editorial Checkers
on:
  push:
    branches: [master, dev]
  pull_request:
    branches: [master, dev]

jobs:
  yml_editorial_checkers:
    runs-on: ubuntu-latest
    container: ruby:3.0-slim
    steps:
    - run: pwd
    - uses: actions/checkout@v3
      with:
       fetch-depth: 1
    - run: gem install rspec
    - name: Run YML and editorial checkers
      run: rspec
    #############
    # IF FAILED #
    #############
    - name: Rerun but only failures, save to file
      if: ${{ failure() }}
      run: rspec --only-failures --format documentation --out tmp/rspec.txt
    - name: Save rspec failure output to GH Actions outputs
      if: ${{ failure() }}
      id: rspec_failures
      run: echo "::set-output name=rspec_txt::$(cat tmp/rspec.txt)"
    - name: Report YML checking failures via PR comment
      if: ${{ failure() }}
      uses: thollander/actions-comment-pull-request@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        comment_includes: Beep boop I'm a bot.
        message: |
          Beep boop I'm a bot. Looks like your VHP curation had some problems. Maybe your YML syntax is wrong, maybe you haven't finished the curation.

          Please click on the "Details" link below and check the output from our YML editorial checkers.

          ${{ steps.rspec_failures.outputs.rspec_txt }}

    ##############
    # IF success #
    ##############
    - name: Report YML checking success via PR comment
      if: ${{ success() }}
      uses: thollander/actions-comment-pull-request@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        comment_includes: Beep boop I'm a bot.
        message: |
          Beep boop I'm a bot. Looks like your curation is valid!

          Make sure that you've updated `curation_level` to the level you were instructed. This ensures you finished the work we expected.

          If so, then you're done! Thank you so much for your volunteer work.

              -The VHP Team





